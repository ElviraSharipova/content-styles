{"ast":null,"code":"import _regeneratorRuntime from\"/home/dekor/eqvium/react_material_test/admin-full/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/home/dekor/eqvium/react_material_test/admin-full/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _slicedToArray from\"/home/dekor/eqvium/react_material_test/admin-full/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import _objectSpread from\"/home/dekor/eqvium/react_material_test/admin-full/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/objectSpread2\";import React from\"react\";import axios from\"axios\";import jwt from\"jsonwebtoken\";import{toast}from\"react-toastify\";import{mockUser}from\"./mock\";import Cookies from'js-cookie';//config\nimport config from\"../../src/config\";var UserStateContext=React.createContext();var UserDispatchContext=React.createContext();function userReducer(state,action){switch(action.type){case\"LOGIN_SUCCESS\":return _objectSpread(_objectSpread({},state),action.payload);case\"REGISTER_REQUEST\":case\"RESET_REQUEST\":case\"PASSWORD_RESET_EMAIL_REQUEST\":return _objectSpread(_objectSpread({},state),{},{isFetching:true,errorMessage:''});case\"SIGN_OUT_SUCCESS\":return _objectSpread({},state);case\"AUTH_INIT_ERROR\":return Object.assign({},state,{currentUser:null,loadingInit:false});case\"REGISTER_SUCCESS\":case\"RESET_SUCCESS\":case\"PASSWORD_RESET_EMAIL_SUCCESS\":return Object.assign({},state,{isFetching:false,errorMessage:''});case'AUTH_FAILURE':return Object.assign({},state,{isFetching:false,errorMessage:action.payload});default:{throw new Error(\"Unhandled action type: \".concat(action.type));}}}function UserProvider(_ref){var children=_ref.children;var _React$useReducer=React.useReducer(userReducer,{isAuthenticated:function isAuthenticated(){var token=localStorage.getItem(\"token\");if(config.isBackend&&token){var date=new Date().getTime()/1000;var data=jwt.decode(token);if(!data)return false;return date<data.exp;}else if(token){return true;}return false;},isFetching:false,errorMessage:'',currentUser:null,loadingInit:true}),_React$useReducer2=_slicedToArray(_React$useReducer,2),state=_React$useReducer2[0],dispatch=_React$useReducer2[1];return/*#__PURE__*/React.createElement(UserStateContext.Provider,{value:state},/*#__PURE__*/React.createElement(UserDispatchContext.Provider,{value:dispatch},children));}function useUserState(){var context=React.useContext(UserStateContext);if(context===undefined){throw new Error(\"useUserState must be used within a UserProvider\");}return context;}function useUserDispatch(){var context=React.useContext(UserDispatchContext);if(context===undefined){throw new Error(\"useUserDispatch must be used within a UserProvider\");}return context;}export{UserProvider,useUserState,useUserDispatch,loginUser,signOut};// ###########################################################\nfunction loginUser(dispatch,login,password,history,setIsLoading,setError){var social=arguments.length>6&&arguments[6]!==undefined?arguments[6]:\"\";setError(false);setIsLoading(true);if(login.length>0&&password.length>0){axios.post(\"/token/\",{\"username\":login,\"password\":password}).then(function(res){var token=res.data;setTimeout(function(){setError(null);setIsLoading(false);receiveToken(token,dispatch);doInit()(dispatch);},2000);}).catch(function(){setError(true);setIsLoading(false);});}else{dispatch({type:\"LOGIN_FAILURE\"});}}export function sendPasswordResetEmail(email){return function(dispatch){if(!config.isBackend){return;}else{dispatch({type:'PASSWORD_RESET_EMAIL_REQUEST'});axios.post(\"/auth/send-password-reset-email\",{email:email}).then(function(res){dispatch({type:'PASSWORD_RESET_EMAIL_SUCCESS'});toast.success(\"Email with resetting instructions has been sent\");}).catch(function(err){dispatch(authError(err.response.data));});}};}function signOut(dispatch,history){localStorage.removeItem(\"token\");localStorage.removeItem(\"user\");localStorage.removeItem('user_id');document.cookie=\"token=;expires=Thu, 01 Jan 1970 00:00:01 GMT;\";axios.defaults.headers.common[\"Authorization\"]=\"\";dispatch({type:\"SIGN_OUT_SUCCESS\"});history.push(\"/login\");}export function receiveToken(token,dispatch){var user;// We check if app runs with backend mode\nif(config.isBackend){user=jwt.decode(token).user;delete user.id;}else{user={email:config.auth.email};}user=jwt.decode(token.access).user_id;axios.get(\"/profiles/\"+user).then(function(res){localStorage.setItem(\"email\",res.data.email);localStorage.setItem(\"phone\",res.data.phone_num);console.log(res.data.email);}).catch(function(err){return console.error(err);});delete user.id;localStorage.setItem(\"token\",token);localStorage.setItem(\"user\",JSON.stringify(user));localStorage.setItem(\"theme\",\"default\");axios.defaults.headers.common[\"Authorization\"]=\"Bearer \"+token;dispatch({type:\"LOGIN_SUCCESS\"});}function findMe(){return _findMe.apply(this,arguments);}function _findMe(){_findMe=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(){var response;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:if(!config.isBackend){_context2.next=7;break;}_context2.next=3;return axios.get('/auth/me');case 3:response=_context2.sent;return _context2.abrupt(\"return\",response.data);case 7:return _context2.abrupt(\"return\",mockUser);case 8:case\"end\":return _context2.stop();}}},_callee2);}));return _findMe.apply(this,arguments);}export function authError(payload){return{type:'AUTH_FAILURE',payload:payload};}export function doInit(){return/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(dispatch){var currentUser,token;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:currentUser=null;if(config.isBackend){_context.next=6;break;}currentUser=mockUser;dispatch({type:'LOGIN_SUCCESS',payload:{currentUser:currentUser}});_context.next=20;break;case 6:_context.prev=6;token=localStorage.getItem('token');if(!token){_context.next=12;break;}_context.next=11;return findMe();case 11:currentUser=_context.sent;case 12:sessionStorage.setItem('user_id',currentUser.id);dispatch({type:'LOGIN_SUCCESS',payload:{currentUser:currentUser}});_context.next=20;break;case 16:_context.prev=16;_context.t0=_context[\"catch\"](6);console.log(_context.t0);dispatch({type:'AUTH_INIT_ERROR',payload:_context.t0});case 20:case\"end\":return _context.stop();}}},_callee,null,[[6,16]]);}));return function(_x){return _ref2.apply(this,arguments);};}();}export function confirmUser(dispatch,login,password,key,history,setIsLoading,setError){return function(){console.log(\"in func\");if(login.length>0&&password.length>0&&key.length>0){axios.defaults.headers['X-CSRFTOKEN']=Cookies.get('csrftoken');axios.post(\"/register/\",{username:login,email:login,password:password,hash:localStorage.getItem(\"verification_key\"),key:key}).then(function(res){dispatch({type:'REGISTER_SUCCESS'});//          toast.success(\"You've been registered successfully. Please check your email for verification link\");\nhistory.push('/login');}).catch(function(err){dispatch(authError(err.response.data));});}else{dispatch(authError('Something was wrong. Try again'));}};}export function registerUser(dispatch,login,history,setIsLoading,setError){var social=arguments.length>5&&arguments[5]!==undefined?arguments[5]:\"\";return function(){dispatch({type:'REGISTER_REQUEST'});if(login.length>0){//        console.log(login, password);\n//        axios.defaults.xsrfCookieName = 'csrftoken';\n//       axios.defaults.headers.xsrfHeaderName = \"X-CSRFTOKEN\"; \naxios.defaults.headers['X-CSRFTOKEN']=Cookies.get('csrftoken');axios.post(\"/register/email/\",{email:login}).then(function(res){//          console.log(res.data.key);\nlocalStorage.setItem(\"verification_key\",res.data.key);dispatch({type:'REGISTER_SUCCESS'});toast.success(\"You've been registered successfully. Please check your email for verification link\");//          console.log(res.data.key);\nhistory.push('/confirm');}).catch(function(err){//console.log(err.response.data); \ndispatch(authError(err.response.data));});}else{dispatch(authError('Something was wrong. Try again'));}};}export function verifyEmail(token,history){return function(dispatch){if(!config.isBackend){history.push('/login');}else{axios.put(\"/auth/verify-email\",{token:token}).then(function(verified){if(verified){toast.success(\"Your email was verified\");}}).catch(function(err){toast.error(err.response.data);}).finally(function(){history.push('/login');});}};}export function resetPassword(token,password,history){return function(dispatch){if(!config.isBackend){history.push('/login');}else{dispatch({type:'RESET_REQUEST'});axios.put(\"/auth/password-reset\",{token:token,password:password}).then(function(res){dispatch({type:'RESET_SUCCESS'});toast.success(\"Password has been updated\");history.push('/login');}).catch(function(err){dispatch(authError(err.response.data));});}};}","map":{"version":3,"sources":["/home/dekor/eqvium/react_material_test/admin-full/src/context/UserContext.js"],"names":["React","axios","jwt","toast","mockUser","Cookies","config","UserStateContext","createContext","UserDispatchContext","userReducer","state","action","type","payload","isFetching","errorMessage","Object","assign","currentUser","loadingInit","Error","UserProvider","children","useReducer","isAuthenticated","token","localStorage","getItem","isBackend","date","Date","getTime","data","decode","exp","dispatch","useUserState","context","useContext","undefined","useUserDispatch","loginUser","signOut","login","password","history","setIsLoading","setError","social","length","post","then","res","setTimeout","receiveToken","doInit","catch","sendPasswordResetEmail","email","success","err","authError","response","removeItem","document","cookie","defaults","headers","common","push","user","id","auth","access","user_id","get","setItem","phone_num","console","log","error","JSON","stringify","findMe","sessionStorage","confirmUser","key","username","hash","registerUser","verifyEmail","put","verified","finally","resetPassword"],"mappings":"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","sourcesContent":["import React from \"react\";\nimport axios from \"axios\";\nimport jwt from \"jsonwebtoken\";\nimport { toast } from \"react-toastify\";\nimport { mockUser } from \"./mock\";\n\nimport Cookies from 'js-cookie';\n\n//config\nimport config from \"../../src/config\";\n\nvar UserStateContext = React.createContext();\nvar UserDispatchContext = React.createContext();\n\nfunction userReducer(state, action) {\n  switch (action.type) {\n    case \"LOGIN_SUCCESS\":\n      return {\n        ...state,\n        ...action.payload\n      };\n    case \"REGISTER_REQUEST\":\n    case \"RESET_REQUEST\":\n    case \"PASSWORD_RESET_EMAIL_REQUEST\":\n      return {\n        ...state,\n        isFetching: true,\n        errorMessage: '',\n      };\n    case \"SIGN_OUT_SUCCESS\":\n      return { ...state };\n    case \"AUTH_INIT_ERROR\":\n      return Object.assign({}, state, {\n          currentUser: null,\n          loadingInit: false,\n      });\n    case \"REGISTER_SUCCESS\":\n    case \"RESET_SUCCESS\":\n    case \"PASSWORD_RESET_EMAIL_SUCCESS\":\n      return Object.assign({}, state, {\n          isFetching: false,\n          errorMessage: '',\n      });\n    case 'AUTH_FAILURE':\n      return Object.assign({}, state, {\n          isFetching: false,\n          errorMessage: action.payload,\n      });\n    default: {\n      throw new Error(`Unhandled action type: ${action.type}`);\n    }\n  }\n}\n\nfunction UserProvider({ children }) {\n  var [state, dispatch] = React.useReducer(userReducer, {\n    isAuthenticated: () => {\n      const token = localStorage.getItem(\"token\")\n      if (config.isBackend && token) {\n        const date = new Date().getTime() / 1000;\n        const data = jwt.decode(token);\n        if (!data) return false;\n        return date < data.exp;\n      } else if (token) {\n        return true\n      }\n      return false;\n    },\n    isFetching: false,\n    errorMessage: '',\n    currentUser: null,\n    loadingInit: true,\n  });\n\n  return (\n    <UserStateContext.Provider value={state}>\n      <UserDispatchContext.Provider value={dispatch}>\n        {children}\n      </UserDispatchContext.Provider>\n    </UserStateContext.Provider>\n  );\n}\n\nfunction useUserState() {\n  var context = React.useContext(UserStateContext);\n  if (context === undefined) {\n    throw new Error(\"useUserState must be used within a UserProvider\");\n  }\n  return context;\n}\n\nfunction useUserDispatch() {\n  var context = React.useContext(UserDispatchContext);\n  if (context === undefined) {\n    throw new Error(\"useUserDispatch must be used within a UserProvider\");\n  }\n  return context;\n}\n\nexport { UserProvider, useUserState, useUserDispatch, loginUser, signOut };\n\n// ###########################################################\n\nfunction loginUser(\n  dispatch,\n  login,\n  password,\n  history,\n  setIsLoading,\n  setError,\n  social = \"\"\n) {\n  setError(false);\n  setIsLoading(true);\n    if (login.length > 0 && password.length > 0) {\n      axios\n        .post(\"/token/\", { \"username\": login, \"password\" : password })\n        .then(res => {\n          const token = res.data;\n          setTimeout(() => {\n            setError(null);\n            setIsLoading(false);\n            receiveToken(token, dispatch);\n            doInit()(dispatch);\n          }, 2000);\n        })\n        .catch(() => {\n          setError(true);\n          setIsLoading(false);\n        });\n    } else {\n      dispatch({ type: \"LOGIN_FAILURE\" });\n    }\n}\n\nexport function sendPasswordResetEmail(email) {\n  return (dispatch) => {\n    if (!config.isBackend) {\n      return\n    } else {\n      dispatch({\n        type: 'PASSWORD_RESET_EMAIL_REQUEST',\n      });\n      axios.post(\"/auth/send-password-reset-email\", {email}).then(res => {\n        dispatch({\n          type: 'PASSWORD_RESET_EMAIL_SUCCESS',\n        });\n        toast.success(\"Email with resetting instructions has been sent\");\n      }).catch(err => {\n        dispatch(authError(err.response.data));\n      })\n    }\n  }\n}\n\nfunction signOut(dispatch, history) {\n  localStorage.removeItem(\"token\");\n  localStorage.removeItem(\"user\");\n  localStorage.removeItem('user_id');\n  document.cookie = \"token=;expires=Thu, 01 Jan 1970 00:00:01 GMT;\";\n  axios.defaults.headers.common[\"Authorization\"] = \"\";\n  dispatch({ type: \"SIGN_OUT_SUCCESS\" });\n  history.push(\"/login\");\n}\n\nexport function receiveToken(token, dispatch) {\n  let user;\n  // We check if app runs with backend mode\n  if (config.isBackend) {\n    user = jwt.decode(token).user;\n    delete user.id;\n  } else {\n    user = {\n      email: config.auth.email\n    };\n  }\n  \n  user = jwt.decode(token.access).user_id;\n  axios.get(\"/profiles/\"+user).then(res => { localStorage.setItem(\"email\", res.data.email); localStorage.setItem(\"phone\", res.data.phone_num); console.log(res.data.email) }).catch(err => console.error(err));\n \n\n  delete user.id;\n\n  \n \n\n  localStorage.setItem(\"token\", token);\n  localStorage.setItem(\"user\", JSON.stringify(user));\n  localStorage.setItem(\"theme\", \"default\");\n  axios.defaults.headers.common[\"Authorization\"] = \"Bearer \" + token;\n  dispatch({ type: \"LOGIN_SUCCESS\" });\n}\n\nasync function findMe() {\n  if (config.isBackend) {\n    const response = await axios.get('/auth/me');\n    return response.data;    \n  } else {\n    return mockUser;\n  }\n}\n\nexport function authError(payload) {\n  return {\n    type: 'AUTH_FAILURE',\n    payload,\n  };\n}\n\nexport function doInit() {\n  return async (dispatch) => {\n    let currentUser = null;\n    if (!config.isBackend) {\n      currentUser = mockUser;\n      \n      dispatch({\n        type: 'LOGIN_SUCCESS',\n        payload: {\n          currentUser,\n        },\n      });\n    } else {\n      try {\n        let token = localStorage.getItem('token');\n        if (token) {\n          currentUser = await findMe();\n        }\n        sessionStorage.setItem('user_id', currentUser.id);\n        dispatch({\n          type: 'LOGIN_SUCCESS',\n          payload: {\n            currentUser,\n          },\n        });\n      } catch (error) {\n        console.log(error);\n\n        dispatch({\n          type: 'AUTH_INIT_ERROR',\n          payload: error,\n        });\n      }\n    }\n  }\n}\n\nexport function confirmUser(\n  dispatch,\n  login,\n  password,\n  key,\n  history,\n  setIsLoading,\n  setError\n) {\n    return () => {\n      console.log(\"in func\");\n      if (login.length > 0 && password.length > 0 && key.length > 0) {\n        axios.defaults.headers['X-CSRFTOKEN'] = Cookies.get('csrftoken');\n        axios.post(\"/register/\", {username: login, email: login, password: password, hash: localStorage.getItem(\"verification_key\"), key: key}).then(res => {\n          dispatch({\n            type: 'REGISTER_SUCCESS'\n          });\n//          toast.success(\"You've been registered successfully. Please check your email for verification link\");\n          history.push('/login');\n        }).catch(err => {\n          dispatch(authError(err.response.data));\n        })\n      } else {\n        dispatch(authError('Something was wrong. Try again'));\n      }\n  };\n}\n\nexport function registerUser(\n  dispatch,\n  login,\n  history,\n  setIsLoading,\n  setError,\n  social = \"\"\n) {\n  return () => {\n      dispatch({\n        type: 'REGISTER_REQUEST',\n      });\n      if (login.length > 0) {\n//        console.log(login, password);\n//        axios.defaults.xsrfCookieName = 'csrftoken';\n//       axios.defaults.headers.xsrfHeaderName = \"X-CSRFTOKEN\"; \n        axios.defaults.headers['X-CSRFTOKEN'] = Cookies.get('csrftoken');\n        axios.post(\"/register/email/\", {email: login}).then(res => {\n//          console.log(res.data.key);\n          localStorage.setItem(\"verification_key\", res.data.key);\n          dispatch({\n            type: 'REGISTER_SUCCESS'\n          });\n          toast.success(\"You've been registered successfully. Please check your email for verification link\");\n//          console.log(res.data.key);\n          history.push('/confirm');\n        }).catch(err => {\n          //console.log(err.response.data); \n          dispatch(authError(err.response.data));\n        })\n  \n      } else {\n        dispatch(authError('Something was wrong. Try again'));\n      }\n  };\n}\n\nexport function verifyEmail(token, history) {\n  return(dispatch) => {\n    if (!config.isBackend) {\n      history.push('/login');\n    } else {\n      axios.put(\"/auth/verify-email\", {token}).then(verified => {\n        if (verified) {\n          toast.success(\"Your email was verified\");\n        }\n      }).catch(err => {\n        toast.error(err.response.data);\n      }).finally(() => {\n        history.push('/login');\n      })\n    }\n  }\n}\n\nexport function resetPassword(token, password, history) {\n  return (dispatch) => {\n    if (!config.isBackend) {\n      history.push('/login');\n    } else {\n      dispatch({\n        type: 'RESET_REQUEST',\n      });\n      axios.put(\"/auth/password-reset\", {token, password}).then(res => {\n          dispatch({\n            type: 'RESET_SUCCESS',\n          });\n          toast.success(\"Password has been updated\");\n        history.push('/login');\n      }).catch(err => {\n        dispatch(authError(err.response.data));\n      })\n    }\n  }\n}\n"]},"metadata":{},"sourceType":"module"}